name: R Analysis Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  analysis:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up R
      uses: r-lib/actions/setup-r@v2
      with:
        r-version: '4.3.0'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libcurl4-openssl-dev libssl-dev libxml2-dev libhdf5-dev
    
    - name: Cache R packages
      uses: actions/cache@v3
      with:
        path: ~/.local/share/renv
        key: ${{ runner.os }}-renv-${{ hashFiles('**/renv.lock') }}
        restore-keys: |
          ${{ runner.os }}-renv-
    
    - name: Install R dependencies
      run: |
        install.packages('renv')
        renv::restore()
      shell: Rscript {0}
    
    - name: Run CPI calculation test
      run: |
        source("3_analysis/utils/utils_io.R")
        # Verify CPI function exists and works
        message("CI: Testing CPI calculation framework...")
        # Add verification tests here
      shell: Rscript {0}
    
    - name: Upload results
      uses: actions/upload-artifact@v3
      with:
        name: analysis-results
        path: 4_results/
        if-no-files-found: warn
